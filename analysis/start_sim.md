СПИСОК ФАЙЛОВ
- scripts/start_sim.sh

## Вход и цель
- [Факт] Скрипт поднимает gRPC-сервер симулятора Q-Sim.
- [Гипотеза] Предназначен для локального тестирования взаимодействия с агентом.

## Сбор контекста
- [Факт] Изучен файл `start_sim.sh` и директории `generated`, `protos`.
- [Гипотеза] Требует Python и пакет `grpc`.

## Локализация артефакта
- [Факт] `scripts/start_sim.sh` в корне проекта.
- [Гипотеза] Может вызываться как из корня, так и через абсолютный путь.

## Фактический разбор
- [Факт] Проверяет наличие `python3` и `grpc`.
- [Факт] При отсутствии сгенерированных protobuf-файлов вызывает `grpc_tools.protoc`.
- [Факт] Запускает `python3 services/q_sim_service/grpc_server.py`.
- [Гипотеза] Сервер слушает порт по умолчанию `50051`.

## Роль в системе и связи
- [Факт] Обеспечивает инфраструктуру для работы `start_agent.sh`.
- [Гипотеза] В будущем может быть заменён контейнерным запуском.

## Несоответствия и риски
- [Гипотеза] Не проверяет, занят ли порт `50051`.
- [Гипотеза] Отсутствие graceful shutdown.

## Мини-патчи (safe-fix)
- [Патч] Добавить проверку порта перед запуском.
- [Патч] Обернуть запуск сервера в `trap` для корректного завершения.

## Рефактор-скетч
```bash
#!/bin/bash
set -e
python3 -m grpc_tools.protoc --proto_path=protos --python_out=generated protos/q_sim_api.proto
python3 services/q_sim_service/grpc_server.py "$@"
```

## Примеры использования
1. `bash scripts/start_sim.sh`
2. `python3 services/q_sim_service/grpc_server.py`
3. `python3 -m grpc_tools.protoc --proto_path=protos --python_out=generated protos/q_sim_api.proto`
4. `lsof -i :50051`
5. `QSIM_PORT=60000 bash scripts/start_sim.sh` (после модификации скрипта)

## Тест-хуки/чек-лист
- Проверить запуск сервера без ошибок.
- Убедиться, что порт `50051` открыт.
- Остановить процесс и проверить освобождение порта.
- Тестировать повторную генерацию protobuf-файлов.
- Проверить совместимость с `start_agent.sh`.

## Вывод
1. Скрипт обеспечивает запуск симулятора gRPC.
2. Требует Python и `grpc`.
3. Порт сервера зафиксирован.
4. Нет проверки занятости порта.
5. Возможны утечки процессов при ошибках.
6. Рекомендуется добавить параметры порта.
7. Доступна автоматическая генерация protobuf.
8. Полезен для локальной отладки.
9. Стоит внедрить обработку сигналов.
10. Расширение для контейнеров отложено.

СПИСОК ФАЙЛОВ
- scripts/start_sim.sh
