СПИСОК ФАЙЛОВ
- scripts/run_tests_and_lint.sh

## Вход и цель
- [Факт] Скрипт запускает тесты, линтер и проверку protobuf-файлов.
- [Гипотеза] Используется разработчиками для быстрой локальной проверки.

## Сбор контекста
- [Факт] Изучен исходник `run_tests_and_lint.sh` и соседние конфигурации.
- [Гипотеза] Дополнительных внешних настроек не требуется.

## Локализация артефакта
- [Факт] `scripts/run_tests_and_lint.sh` в корне проекта `QIKI_DTMP`.
- [Гипотеза] Запускается из любой директории, но опирается на структуру репозитория.

## Фактический разбор
- [Факт] `set -e` прекращает выполнение при ошибке.
- [Факт] Определяются `SCRIPT_DIR` и `PROJECT_ROOT` через `readlink`.
- [Факт] `PYTHONPATH` расширяется корнем проекта.
- [Факт] Выполняется `pytest` для `services/q_core_agent/tests`.
- [Факт] Линтер `ruff` проверяет `services/q_core_agent/`.
- [Факт] `protoc` прогоняет все `.proto` из каталога `protos` на синтаксис.
- [Гипотеза] Проверка `.proto` не генерирует файлов, служит валидацией.

## Роль в системе и связи
- [Факт] Скрипт агрегирует проверки качества кода.
- [Гипотеза] Используется в CI перед коммитом.

## Несоответствия и риски
- [Гипотеза] Отсутствие `protoc` или `ruff` приводит к немедленному падению.
- [Гипотеза] Жёсткий путь к тестам не учитывает другие сервисы.

## Мини-патчи (safe-fix)
- [Патч] Добавить проверку наличия `protoc` и `ruff` с понятным сообщением.

## Рефактор-скетч
```bash
#!/bin/bash
set -e
command -v ruff >/dev/null || { echo 'ruff missing'; exit 1; }
command -v protoc >/dev/null || { echo 'protoc missing'; exit 1; }
pytest services/q_core_agent/tests
ruff check services/q_core_agent
find protos -name '*.proto' -print0 | xargs -0 protoc --proto_path=protos --descriptor_set_out=/dev/null
```

## Примеры использования
1. `bash scripts/run_tests_and_lint.sh`
2. `PYTHONPATH=. pytest services/q_core_agent/tests`
3. `ruff check services/q_core_agent`
4. `find protos -name '*.proto' | xargs -n1 protoc --descriptor_set_out=/dev/null`
5. `export PYTHONPATH=$(pwd); pytest services/q_core_agent/tests/test_agent.py`

## Тест-хуки/чек-лист
- Проверить, что `pytest` завершается без ошибок.
- Убедиться, что `ruff` не выдаёт предупреждений.
- Валидация `.proto` файлов без генерации артефактов.
- Проверка корректности `PYTHONPATH` для импорта модулей.
- Отслеживание ненулевого выхода скрипта.

## Вывод
1. Скрипт централизует запуск тестов и линтера.
2. Зависит от наличия `pytest`, `ruff`, `protoc`.
3. Жёсткие пути ограничивают расширяемость.
4. Нет предварительной проверки инструментов.
5. Дополнительная логика могла бы улучшить DX.
6. Стоит добавить параметры для других сервисов.
7. В текущем виде подходит для локальной валидации.
8. CI может использовать скрипт без модификаций.
9. Отложить генерацию отчётов для интеграции в pipelines.
10. Немедленно добавить проверки наличия инструментов.

СПИСОК ФАЙЛОВ
- scripts/run_tests_and_lint.sh
