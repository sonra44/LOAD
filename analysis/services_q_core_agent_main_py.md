# Анализ /home/sonra44/QIKI_DTMP/services/q_core_agent/main.py

## СПИСОК ФАЙЛОВ
- /home/sonra44/QIKI_DTMP/services/q_core_agent/main.py

## Вход и цель
- [Факт] Точка входа для запуска Q-Core Agent в режимах mock, gRPC и legacy.
- [Цель] Рассмотреть CLI-параметры, цикл исполнения и взаимодействие со StateStore.

## Сбор контекста
- [Факт] Используются argparse, asyncio, yaml, signal, а также множество внутренних модулей.
- [Факт] Загружается конфигурация `config.yaml` и логирование `logging.yaml`.
- [Гипотеза] Предполагается наличие сервиса `QSimService` при запуске без флагов.

## Локализация артефакта
- [Факт] Путь: `services/q_core_agent/main.py`.
- [Факт] Вызывается при исполнении пакета как скрипта (`python -m services.q_core_agent.main`).

## Фактический разбор
- [Факт] Функция `main()` парсит флаги `--mock` и `--grpc`.
- [Факт] Настраивает логирование и обработку сигналов SIGINT/SIGTERM.
- [Факт] В зависимости от флагов выбирает `MockDataProvider`, `GrpcDataProvider` или `QSimDataProvider`.
- [Факт] Поддерживается режим StateStore через переменную `QIKI_USE_STATESTORE`.
- [Гипотеза] Нет проверки конфликтующих флагов (`--mock` и `--grpc` одновременно).

## Роль в системе и связи
- [Факт] Управляет жизненным циклом агента и orchestrator'а.
- [Гипотеза] Служит основой для CLI-утилиты развертывания.

## Несоответствия и риски
- [Риск|Med] При отсутствии конфигурационного файла `config.yaml` приложение завершается с исключением.
- [Риск|Low] Одновременное указание `--mock` и `--grpc` обрабатывается без явного предупреждения.

## Мини-патчи (safe-fix)
- [Патч] Добавить взаимно исключающие группы аргументов для `--mock` и `--grpc`.
- [Патч] При отсутствии конфигурации выводить понятное сообщение и использовать значения по умолчанию.

## Рефактор-скетч
```python
parser = argparse.ArgumentParser()
mode = parser.add_mutually_exclusive_group()
mode.add_argument('--mock', action='store_true')
mode.add_argument('--grpc', action='store_true')
```

## Примеры использования
```bash
# Запуск в режиме mock
python services/q_core_agent/main.py --mock

# Запуск с gRPC провайдером
python services/q_core_agent/main.py --grpc --config custom.yaml

# Установка переменной окружения для StateStore
QIKI_USE_STATESTORE=true python services/q_core_agent/main.py --mock

# Использование как модуля
python -m services.q_core_agent.main --grpc

# Проверка помощи по CLI
python services/q_core_agent/main.py -h
```

## Тест-хуки/чек-лист
- [ ] Проверить запуск в каждом режиме (`mock`, `grpc`, `legacy`).
- [ ] Имитировать отсутствие `config.yaml` и проверить обработку.
- [ ] Использовать `QIKI_USE_STATESTORE=true` и убедиться в асинхронной работе.

## Вывод
1. [Факт] `main.py` объединяет конфигурацию, провайдеры и orchestrator.
2. [Факт] Поддерживает несколько режимов запуска.
3. [Риск] Отсутствует контроль за взаимоисключающими флагами.
4. [Риск] Жесткая зависимость от файлов конфигурации.
5. [Патч] Ввести взаимно исключающие аргументы.
6. [Патч] Добавить обработку отсутствия конфигов.
7. [Гипотеза] Возможно выделение CLI в отдельный модуль.
8. [Факт] Реализован механизм graceful shutdown через сигналы.
9. [Гипотеза] Возможно расширение флагами для уровня логирования.
10. [Цель] Сделать запуск агента более дружелюбным и надежным.
