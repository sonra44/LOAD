# СПИСОК ФАЙЛОВ
- /home/sonra44/QIKI_DTMP/services/q_core_agent/.qiki_ship.id

## Вход и цель
- [Факт] Анализ текстового файла с идентификатором корабля.
- [Факт] Итог: обзор структуры и рисков, рекомендации по улучшению.

## Сбор контекста
- [Факт] Файл содержит строку `QIKI-SHIP-20250730-73249605` без перевода строки.
- [Гипотеза] Используется для однозначной идентификации экземпляра корабля.

## Локализация артефакта
- [Факт] Путь: `/home/sonra44/QIKI_DTMP/services/q_core_agent/.qiki_ship.id`.
- [Факт] Формат: простой текст UTF-8, 1 строка.

## Фактический разбор
- [Факт] Нет дополнительных полей или метаданных.
- [Факт] Отсутствие перевода строки может приводить к склейке с выводом оболочки.
- [Гипотеза] Структура `QIKI-SHIP-<DATE>-<SEQ>` закодирована в имени.

## Роль в системе и связи
- [Факт] Идентификатор может использоваться при логировании и обмене сообщениями.
- [Гипотеза] Другие сервисы читают файл при старте для привязки конфигурации.

## Несоответствия и риски
- [Факт] Нет проверки формата ID. — Приоритет: Med.
- [Факт] Отсутствует перевод строки. — Приоритет: Low.
- [Гипотеза] При удалении файла сервис может упасть. — Приоритет: High.

## Мини-патчи (safe-fix)
- [Патч] Добавить перевод строки в конец файла.
- [Патч] При чтении валидировать регулярным выражением `^QIKI-SHIP-\d{8}-\d+$`.
- [Патч] Логировать отсутствие файла и использовать запасной ID.

## Рефактор-скетч (по желанию)
```python
import re

def load_ship_id(path: str) -> str:
    with open(path, 'r', encoding='utf-8') as fh:
        ship_id = fh.read().strip()
    if not re.fullmatch(r"QIKI-SHIP-\d{8}-\d+", ship_id):
        raise ValueError("invalid ship id")
    return ship_id
```

## Примеры использования
```bash
cat /home/sonra44/QIKI_DTMP/services/q_core_agent/.qiki_ship.id
```
```bash
printf 'NEW-ID' > /tmp/ship.id && cat /tmp/ship.id
```
```python
with open('.qiki_ship.id') as f:
    print(f.read().strip())
```
```python
import re, pathlib
if re.fullmatch(r"QIKI-SHIP-\d{8}-\d+", pathlib.Path('.qiki_ship.id').read_text().strip()):
    print('ok')
```
```bash
sed -n '1p' /home/sonra44/QIKI_DTMP/services/q_core_agent/.qiki_ship.id
```

## Тест-хуки/чек-лист
- Проверить существование файла при старте сервиса.
- Валидация формата идентификатора.
- Поведение при пустом файле.
- Логирование при неверном ID.
- Повторное чтение после обновления файла.

## Вывод
- Файл содержит постоянный идентификатор корабля.
- Отсутствует перевод строки в конце файла.
- Формат не контролируется и может быть испорчен.
- При удалении файла возможен сбой загрузки.
- Нужно добавить проверку формата.
- Логи должны фиксировать проблемы с ID.
- Стоит предусмотреть запасной механизм генерации ID.
- Перевод строки улучшит читаемость в терминале.
- Полезно документировать структуру ID.
- Срочных исправлений немного, но контроль необходим.

# СПИСОК ФАЙЛОВ
- /home/sonra44/QIKI_DTMP/services/q_core_agent/.qiki_ship.id
