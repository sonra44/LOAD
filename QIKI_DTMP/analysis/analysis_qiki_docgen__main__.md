СПИСОК ФАЙЛОВ
- tools/qiki_docgen/__main__.py

## Вход и цель
[Факт] Требуется описать точку входа инструмента `qiki_docgen` и подготовить рекомендации.

## Сбор контекста
- [Факт] В модуле используются функции генератора из `core.generator`.
- [Факт] Рядом лежит `config.yaml` и пакет `core/`.
- [Гипотеза] Используется для автоматизации документации и протоколов.

## Локализация артефакта
[Факт] Путь: `tools/qiki_docgen/__main__.py`; запускается командой `python -m tools.qiki_docgen`.
[Гипотеза] Требует установленного `protoc` и Python 3.8+.

## Фактический разбор
- Импорты: argparse, os, logging, функции `create_design_document`, `compile_protos`, `build_readme`.
- Глобальные переменные: `_TOOL_ROOT`, `_PROJECT_ROOT`, `DOCS_DIR`.
- Функция `main`:
    - [Факт] Разбирает аргументы, поддерживает режим `--dry-run`.
    - [Факт] Подкоманды: `new`, `compile-protos`, `build-readme`.
    - [Факт] В `new` создаёт директорию компонента и шаблонные файлы.
    - [Факт] Ошибки логируются и приводят к `sys.exit(1)`.
- Граничные случаи:
    - [Гипотеза] При отсутствии `protoc` команда `compile-protos` завершится ошибкой.

## Роль в системе и связи
- [Факт] Служит CLI-инструментом для генерации документации и proto-контрактов.
- [Гипотеза] Может использоваться в CI для сборки README.

## Несоответствия и риски
- [Факт] Нет проверки существования `protoc` до запуска. (Med)
- [Гипотеза] Параметр `--template` может привести к отсутствию файла шаблона. (Low)
- [Факт] Логирование на уровне INFO может захламить вывод при CI. (Low)

## Мини-патчи (safe-fix)
- [Патч] Перед `compile_protos` проверять наличие команды `protoc`.
- [Патч] Добавить валидацию имени шаблона.
- [Патч] Позволить настройку уровня логирования через аргумент.

## Рефактор-скетч
```python
def main(argv=None):
    parser = build_parser()
    args = parser.parse_args(argv)
    dispatch_command(args)
```

## Примеры использования
```bash
# 1. Создание нового компонента
python -m tools.qiki_docgen new Sensor --dry-run
```
```bash
# 2. Компиляция всех proto
python -m tools.qiki_docgen compile-protos
```
```bash
# 3. Сборка README
python -m tools.qiki_docgen build-readme --dry-run
```
```python
# 4. Вызов main из Python
from tools.qiki_docgen.__main__ import main
main(["new", "Core", "--dry-run"])
```
```python
# 5. Проверка справки
from subprocess import run
run(["python", "-m", "tools.qiki_docgen", "--help"])
```

## Тест-хуки/чек-лист
- [Факт] Юнит-тест: запуск `main(["new", name])` создаёт файлы.
- [Факт] Интеграция: наличие `protoc` перед `compile-protos`.
- [Гипотеза] Тест шаблонов: при неверном шаблоне выбрасывается исключение.

## Вывод
1. CLI покрывает создание компонентов и компиляцию протоков.
2. Режим Dry Run предотвращает изменение файлов.
3. Путь к проекту вычисляется через `_PROJECT_ROOT`.
4. Отсутствует явная проверка наличия `protoc`.
5. Логирование фиксировано на INFO.
6. Подкоманда `new` создаёт директорию и файлы.
7. Ошибки обрабатываются общим `except` и логируются.
8. Нет поддержки пользовательских шаблонов вне `available_templates`.
9. Выходные коды 1 при ошибке.
10. Первым шагом стоит добавить проверки зависимостей и шаблонов.

СПИСОК ФАЙЛОВ
- tools/qiki_docgen/__main__.py
