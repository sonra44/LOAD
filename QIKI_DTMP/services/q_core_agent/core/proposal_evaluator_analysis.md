СПИСОК ФАЙЛОВ
- services/q_core_agent/core/proposal_evaluator.py

## Вход и цель
- [Факт] Рассмотреть `proposal_evaluator.py` — механизм выбора предложений.
- [Гипотеза] Улучшить понимание приоритетов и порогов.

## Сбор контекста
- [Факт] Использует `IProposalEvaluator`, `agent_logger`, proto `Proposal`.
- [Гипотеза] Взаимодействует с `NeuralEngine` и другими источниками предложений.

## Локализация артефакта
- [Факт] Путь: `services/q_core_agent/core/proposal_evaluator.py`.
- [Факт] Конфигурация передаётся через `proposal_confidence_threshold`.

## Фактический разбор
- [Факт] Метод `evaluate_proposals` сортирует входной список по типу и приоритету.
- [Факт] Отбор происходит по наибольшему приоритету и достаточной `confidence`.
- [Гипотеза] С текущей логикой принимается максимум одно предложение.

## Роль в системе и связи
- [Факт] Фильтрует предложения перед выполнением действий корабля.
- [Гипотеза] Может быть расширен для работы с несколькими предложениями одновременно.

## Несоответствия и риски
- [Факт] Сравнение `proposal.type` полагается на enum-значения — при изменении нумерации возможны ошибки (Med).
- [Гипотеза] Не проверяется уникальность `proposal_id` — риск дублей (Low).

## Мини-патчи (safe-fix)
- [Патч] Явно задать приоритет типов в словаре вместо использования ordinal.
- [Патч] Добавить валидацию уникальности `proposal_id`.

## Рефактор-скетч
```python
# [Патч] явное сравнение типов
TYPE_PRIORITY = {Proposal.ProposalType.SAFETY: 1, Proposal.ProposalType.PLANNING: 2}
sorted_proposals = sorted(proposals,
                          key=lambda p: (TYPE_PRIORITY.get(p.type, 99), -p.priority))
```

## Примеры использования
```python
from core.proposal_evaluator import ProposalEvaluator
pe = ProposalEvaluator({"proposal_confidence_threshold": 0.7})
pe.evaluate_proposals([proposal1, proposal2])  # [Факт]
```
```python
ProposalEvaluator({}).evaluate_proposals([])               # [Факт] вернёт []
```
```bash
pytest tests/test_agent.py::test_proposal_evaluator        # [Факт]
```
```bash
python -m core.proposal_evaluator                          # [Гипотеза] интерактивное тестирование
```
```bash
echo "Ensure enums stable"                                 # [Факт] напоминание
```

## Тест-хуки/чек-лист
- [Факт] Проверить сортировку при смешанных типах и приоритетах.
- [Факт] Проверить поведение при `confidence` ниже порога.
- [Гипотеза] Тест на множественные предложения одинакового приоритета.

## Вывод
- [Факт] Модуль корректно фильтрует предложения по приоритету и уверенности.
- [Факт] Возможны риски при изменении enum-значений типов.
- [Патч] Использовать явное отображение приоритетов и проверку ID.
- [Гипотеза] Будущее развитие — поддержка нескольких принятых предложений.
- [Факт] Код компактный и легко тестируется.
- [Гипотеза] Порог `confidence` стоит адаптировать под тип предложения.
- [Факт] Текущая реализация работает в синхронном режиме.
- [Патч] Логи добавить уровень DEBUG для отслеживания сортировки.
- [Гипотеза] Возможно использование весов для `priority` и `confidence`.
- [Факт] Модуль критичен для безопасности миссий.

СПИСОК ФАЙЛОВ
- services/q_core_agent/core/proposal_evaluator.py
