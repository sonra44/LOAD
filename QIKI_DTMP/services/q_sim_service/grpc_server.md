# СПИСОК ФАЙЛОВ
- services/q_sim_service/grpc_server.py

## Вход и цель
[Факт] Модуль запуска gRPC сервера для Q-Sim Service.
[Гипотеза] Обеспечивает доступ к данным сенсоров и управлению актуаторами.

## Сбор контекста
[Факт] Импортирует `grpc`, `futures`, `QSimService`, сгенерированные `q_sim_api_pb2`.* и `agent_logger`.
[Факт] Использует `yaml` при запуске как скрипта.
[Гипотеза] Ориентирован на локальную симуляцию.

## Локализация артефакта
[Факт] Путь: `services/q_sim_service/grpc_server.py`.
[Гипотеза] Запускается командой `python grpc_server.py`.

## Фактический разбор
[Факт] Класс `QSimGrpcServicer` реализует методы: `GetSensorData`, `SendActuatorCommand`, `HealthCheck`.
[Факт] Функция `serve` создаёт сервер, регистрирует сервисер, обрабатывает сигналы.
[Факт] В блоке `__main__` настраивается логирование и загрузка конфига.
[Гипотеза] Отсутствует явное закрытие сервера при ошибках.

## Роль в системе и связи
[Факт] Является фронт-эндом симулятора, взаимодействует с `QSimService` и внешними клиентами.
[Гипотеза] Может использоваться тестами для интеграции.

## Несоответствия и риски
- High: [Факт] Конец файла не имеет новой строки и содержит лишний текст после `serve(config, grpc_port)`.
- Med: [Гипотеза] Ошибки в `GetSensorData`/`SendActuatorCommand` возвращают `None`/`Empty` без подробностей.
- Low: [Факт] Порт и адрес сервера захардкожены.

## Мини-патчи (safe-fix)
[Патч] Добавить перевод строки в конце файла и очистить артефакты.
[Патч] Возвращать подробные сообщения об ошибках.

## Рефактор-скетч
```python
def serve(config, port=50051):
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    add_QSimAPIServicer_to_server(QSimGrpcServicer(QSimService(config)), server)
    server.add_insecure_port(f'[::]:{port}')
    server.start()
    server.wait_for_termination()
```

## Примеры использования
```bash
# 1. Запуск сервера
python services/q_sim_service/grpc_server.py

# 2. Проверка здоровья
grpcurl -plaintext localhost:50051 q_sim_api.QSimAPI/HealthCheck

# 3. Получение данных сенсоров
grpcurl -plaintext localhost:50051 q_sim_api.QSimAPI/GetSensorData

# 4. Отправка команды актуатору
grpcurl -plaintext -d '{"actuator_id":{"value":"motor_left"}}' localhost:50051 q_sim_api.QSimAPI/SendActuatorCommand

# 5. Завершение сервера сигналом
pkill -f grpc_server.py
```

## Тест-хуки/чек-лист
- [Факт] Проверить, что сервер поднимается на указанном порту.
- [Гипотеза] Тестировать корректную обработку исключений в методах servicer.
- [Факт] Убедиться, что сигнал SIGTERM завершает сервер без утечек.

## Вывод
1. [Факт] gRPC сервер обеспечивает интерфейс к симулятору.
2. [Патч] Очистить окончание файла и добавить newline.
3. [Гипотеза] Возможно расширение API дополнительными методами.
4. [Факт] Обработка сигналов реализована вручную.
5. [Гипотеза] Стоит параметризовать порт через конфиг.
6. [Факт] Методы servicer ловят исключения и логируют ошибки.
7. [Гипотеза] Клиентам нужны детальные сообщения об ошибках.
8. [Факт] Примеры демонстрируют gRPC-взаимодействие.
9. [Гипотеза] Интеграционные тесты должны эмулировать клиента.
10. [Факт] Модуль готов к доработкам.

---
СПИСОК ФАЙЛОВ
- services/q_sim_service/grpc_server.py
