# СПИСОК ФАЙЛОВ
- services/q_sim_service/core/world_model.py

## Вход и цель
[Факт] Класс `WorldModel` описывает состояние бота в симуляции.
[Гипотеза] Используется Q-Sim Service для эмуляции движения и батареи.

## Сбор контекста
[Факт] Импортируются `ActuatorCommand`, `Vector3`, `Unit` и логгер.
[Факт] Методы `update`, `step`, `get_state` определяют поведение.
[Гипотеза] Внешние компоненты отправляют команды через gRPC.

## Локализация артефакта
[Факт] Путь: `services/q_sim_service/core/world_model.py`.
[Гипотеза] Версия Python 3.10+, вызывается из `QSimService`.

## Фактический разбор
[Факт] Конструктор инициализирует позицию (Vector3), курс, батарею и скорость.
[Факт] `update` обрабатывает команды моторов: `set_velocity_percent`, `rotate_degrees_per_sec`.
[Факт] `step` изменяет позицию по скорости и курсу, расходует батарею.
[Факт] `get_state` возвращает словарь состояния.
[Гипотеза] Не обрабатываются единицы измерения `Unit`.

## Роль в системе и связи
[Факт] WorldModel служит источником истины симуляции.
[Гипотеза] Его данные публикуются через API сенсоров.

## Несоответствия и риски
- Med: [Факт] командные строки сравниваются по `command.command_type` как строке, возможен mismatch.
- High: [Гипотеза] отсутствие обработки других актуаторов может привести к игнорированию команд.
- Low: [Факт] простая модель батареи без нижнего порога.

## Мини-патчи (safe-fix)
[Патч] Использовать Enum для `command_type` вместо строк.
[Патч] Добавить защиту от отрицательного уровня батареи.

## Рефактор-скетч
```python
class WorldModel:
    def __init__(self):
        self.position = Vector3()
        self.heading = 0.0
        self.battery_level = 100.0
        self.speed = 0.0
```

## Примеры использования
```python
# 1. Создание модели
wm = WorldModel()
print(wm.get_state())

# 2. Применение команды скорости
cmd = ActuatorCommand(actuator_id=Unit(value="motor_left"), command_type="set_velocity_percent", int_value=50)
wm.update(cmd)

# 3. Шаг симуляции на 1 секунду
wm.step(1.0)

# 4. Поворот на 90 градусов
cmd = ActuatorCommand(actuator_id=Unit(value="motor_left"), command_type="rotate_degrees_per_sec", int_value=90)
wm.update(cmd)

# 5. Получение состояния после шага
print(wm.get_state())
```

## Тест-хуки/чек-лист
- [Факт] Проверить корректность движения по оси X/Y при разных курсах.
- [Факт] Убедиться, что уровень батареи не уходит ниже 0.
- [Гипотеза] Добавить тест на неизвестный `command_type`.

## Вывод
1. [Факт] WorldModel моделирует положение и батарею.
2. [Патч] Перейти на строгие enum для типов команд.
3. [Факт] Обновление поддерживает базовые моторы.
4. [Гипотеза] Расширение необходимо для других актуаторов.
5. [Факт] `step` использует синусы/косинусы для движения.
6. [Патч] Защитить от отрицательного заряда.
7. [Гипотеза] Возможно добавить шум сенсоров.
8. [Факт] Примеры демонстрируют базовое использование.
9. [Гипотеза] Интеграционные тесты должны покрыть крайние углы.
10. [Факт] Код готов к расширению.

---
СПИСОК ФАЙЛОВ
- services/q_sim_service/core/world_model.py
